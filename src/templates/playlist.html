<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Playlists</title>
    <script>
        (function() {
            const theme = localStorage.getItem('inkypi-theme') ||
                         (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();
    </script>
    <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/main.css') }}">
    <script src="{{ url_for('static', filename='scripts/dark_mode.js') }}"></script>
    <script src="{{ url_for('static', filename='scripts/response_modal.js') }}"></script>
    <style>
        /* Plugin Instance Thumbnail */
        .plugin-thumbnail-container {
            position: relative;
            cursor: pointer;
            margin-left: 8px;
        }

        .plugin-thumbnail {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            transition: transform 0.2s ease, border-color 0.2s ease;
        }

        .plugin-thumbnail:hover {
            transform: scale(1.1);
            border-color: var(--accent-primary);
        }

        /* Thumbnail Preview Modal */
        .thumbnail-preview-modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-overlay);
            backdrop-filter: blur(3px);
        }

        .thumbnail-preview-content {
            position: relative;
            margin: 5% auto;
            padding: 20px;
            width: 90%;
            max-width: 800px;
            background-color: var(--modal-bg);
            border-radius: 12px;
            box-shadow: 0 4px 20px var(--shadow-medium);
        }

        .thumbnail-preview-content img {
            width: 100%;
            height: auto;
            border-radius: 8px;
        }

        .thumbnail-preview-close {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 35px;
            font-weight: bold;
            color: var(--close-btn-color);
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .thumbnail-preview-close:hover,
        .thumbnail-preview-close:focus {
            color: var(--close-btn-hover);
        }

        .thumbnail-preview-info {
            margin-top: 10px;
            padding: 10px;
            background-color: var(--bg-primary);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 14px;
        }
    </style>
    <script>
        async function deletePluginInstance(playlistName, pluginId, pluginInstance) {
            try {
                const response = await fetch("{{ url_for('plugin.delete_plugin_instance') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        playlist_name: playlistName,
                        plugin_id: pluginId,
                        plugin_instance: pluginInstance
                    })
                });

                const result = await response.json();
                if (response.ok) {
                    sessionStorage.setItem("storedMessage", JSON.stringify({ type: "success", text: `Success! ${result.message}` }));
                    location.reload();
                } else {
                    showResponseModal('failure', `Error!  ${result.error}`);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while processing your request.');
            }
        }

        function showThumbnailPreview(playlistName, pluginId, instanceName) {
            const modal = document.getElementById('thumbnailPreviewModal');
            const img = document.getElementById('thumbnailPreviewImage');
            const info = document.getElementById('thumbnailPreviewInfo');

            const imageUrl = `/plugin_instance_image/${encodeURIComponent(playlistName)}/${encodeURIComponent(pluginId)}/${encodeURIComponent(instanceName)}`;
            img.src = imageUrl;
            info.textContent = `Plugin: ${pluginId} | Instance: ${instanceName}`;
            modal.style.display = 'block';
        }

        function closeThumbnailPreview() {
            const modal = document.getElementById('thumbnailPreviewModal');
            modal.style.display = 'none';
        }

        // Close modal when clicking outside the image
        window.onclick = function(event) {
            const modal = document.getElementById('thumbnailPreviewModal');
            if (event.target === modal) {
                closeThumbnailPreview();
            }
        }

        async function displayPluginInstance(playlistName, pluginId, pluginInstance) {
            const loadingIndicator = document.getElementById(pluginInstance)?.querySelector('.loading-indicator');
            loadingIndicator.style.display = 'block';
            try {
                const response = await fetch("{{ url_for('plugin.display_plugin_instance') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        playlist_name: playlistName,
                        plugin_id: pluginId,
                        plugin_instance: pluginInstance
                    })
                });

                const result = await response.json();
                if (response.ok) {
                    sessionStorage.setItem("storedMessage", JSON.stringify({ type: "success", text: `Success! ${result.message}` }));
                    location.reload();
                } else {
                    showResponseModal('failure', `Error!  ${result.error}`);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while processing your request.');
            } finally {
                // Hide loading indicator after the action is complete
                loadingIndicator.style.display = 'none';
            }
        }

        // Open modal for **creating** a new playlist
        function openCreateModal() {
            document.getElementById("modalTitle").textContent = "New Playlist";
            document.getElementById("playlist_name").value = "";
            document.getElementById("editingPlaylistName").value = ""; // Empty value means it's new
            document.getElementById("start_time").value = "00:00";
            document.getElementById("end_time").value = "24:00";

            document.getElementById("saveButton").setAttribute("onclick", "createPlaylist()");
            document.getElementById("deleteButton").classList.add("hidden"); // Hide delete button

            document.getElementById("playlistModal").style.display = "block";
        }

        // Open modal for **editing** an existing playlist
        function openEditModal(playlistName, startTime, endTime) {
            document.getElementById("modalTitle").textContent = "Update Playlist";
            document.getElementById("playlist_name").value = playlistName;
            document.getElementById("editingPlaylistName").value = playlistName;
            document.getElementById("start_time").value = startTime;
            document.getElementById("end_time").value = endTime;

            document.getElementById("saveButton").setAttribute("onclick", "updatePlaylist()");
            document.getElementById("deleteButton").classList.remove("hidden"); // Show delete button

            document.getElementById("playlistModal").style.display = "block";
        }

        function openModal() {
            const modal = document.getElementById('playlistModal');
            modal.style.display = 'block';
        }

        function closeModal() {
            const modal = document.getElementById('playlistModal');
            modal.style.display = 'none';
        }

        async function createPlaylist() {
            let playlistName = document.getElementById("playlist_name").value.trim();
            let startTime = document.getElementById("start_time").value;
            let endTime = document.getElementById("end_time").value;

            try {
                const response = await fetch("{{ url_for('playlist.create_playlist') }}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ playlist_name: playlistName, start_time: startTime, end_time: endTime })
                });

                const result = await response.json();
                if (response.ok) {
                    closeModal(); // Close the modal on success
                    sessionStorage.setItem("storedMessage", JSON.stringify({ type: "success", text: `Success! ${result.message}` }));
                    location.reload();
                } else {
                    showResponseModal('failure', `Error!  ${result.error}`);
                }
            } catch (error) {
                console.error("Error:", error);
                alert('An error occurred while processing your request.');
            }
        }

        async function updatePlaylist() {
            let oldName = document.getElementById("editingPlaylistName").value;
            let newName = document.getElementById("playlist_name").value;
            let startTime = document.getElementById("start_time").value;
            let endTime = document.getElementById("end_time").value;

            try {
                const response = await fetch("{{ url_for('playlist.update_playlist', playlist_name='') }}" + oldName, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ new_name: newName, start_time: startTime, end_time: endTime })
                });

                const result = await response.json();
                if (response.ok) {
                    closeModal(); // Close the modal after success
                    sessionStorage.setItem("storedMessage", JSON.stringify({ type: "success", text: `Success! ${result.message}` }));
                    location.reload();
                } else {
                    showResponseModal('failure', `Error!  ${result.error}`);
                }
            } catch (error) {
                console.error("Error:", error);
                alert('An error occurred while processing your request.');
            }
        }

        async function deletePlaylist() {
            let name = document.getElementById("editingPlaylistName").value;
            try {
                const response = await fetch("{{ url_for('playlist.delete_playlist', playlist_name='') }}" + name, {
                    method: "DELETE",
                });

                const result = await response.json();
                if (response.ok) {
                    closeModal(); // Close the modal after success
                    sessionStorage.setItem("storedMessage", JSON.stringify({ type: "success", text: `Success! ${result.message}` }));
                    location.reload();
                } else {
                    showResponseModal('failure', `Error!  ${result.error}`);
                }
            } catch (error) {
                console.error("Error:", error);
                alert('An error occurred while processing your request.');
            }
        }

        function populateTimeOptions() {
            let startSelect = document.getElementById("start_time");
            let endSelect = document.getElementById("end_time");

            startSelect.innerHTML = "";
            endSelect.innerHTML = "";

            for (let hour = 0; hour < 24; hour++) { // 24-hour format (0-23)
                for (let minutes of [0, 15, 30, 45]) {
                    let time = hour.toString().padStart(2, '0') + ":" + minutes.toString().padStart(2, '0');
                    startSelect.innerHTML += `<option value="${time}">${time}</option>`;
                    endSelect.innerHTML += `<option value="${time}">${time}</option>`;
                }
            }
            startSelect.innerHTML += `<option value="24:00">24:00</option>`;
            endSelect.innerHTML += `<option value="24:00">24:00</option>`;
        }

        document.addEventListener("DOMContentLoaded", populateTimeOptions);

        window.addEventListener("load", function () {
            let storedMessage = sessionStorage.getItem("storedMessage");
            if (storedMessage) {
                let { type, text } = JSON.parse(storedMessage);
                showResponseModal(type, text);
                sessionStorage.removeItem("storedMessage"); // Clear stored message after displaying
            }
        });

        // Schedule editing functions
        function openEditScheduleModal(button) {
            const pluginId = button.dataset.pluginId;
            const instanceName = button.dataset.instanceName;
            const refreshConfig = JSON.parse(button.dataset.refresh);
            
            document.getElementById("schedule_plugin_id").value = pluginId;
            document.getElementById("schedule_instance_name").value = instanceName;
            
            // Determine refresh type and populate form
            if (refreshConfig.interval !== undefined) {
                // Interval-based refresh
                document.getElementById("schedule-refresh-interval").checked = true;
                const seconds = refreshConfig.interval;
                if (seconds % 86400 === 0) {
                    document.getElementById("schedule-interval").value = seconds / 86400;
                    document.getElementById("schedule-unit").value = "day";
                } else if (seconds % 3600 === 0) {
                    document.getElementById("schedule-interval").value = seconds / 3600;
                    document.getElementById("schedule-unit").value = "hour";
                } else {
                    document.getElementById("schedule-interval").value = seconds / 60;
                    document.getElementById("schedule-unit").value = "minute";
                }
            } else if (refreshConfig.scheduled !== undefined) {
                // Scheduled refresh
                document.getElementById("schedule-refresh-scheduled").checked = true;
                document.getElementById("schedule-scheduled").value = refreshConfig.scheduled;
            } else if (refreshConfig.cron !== undefined) {
                // Cron-based refresh
                document.getElementById("schedule-refresh-cron").checked = true;
                document.getElementById("schedule-cronExpression").value = refreshConfig.cron;
            }
            
            document.getElementById("scheduleModal").style.display = "block";
        }

        function closeScheduleModal() {
            document.getElementById("scheduleModal").style.display = "none";
        }

        async function updatePluginSchedule() {
            const pluginId = document.getElementById("schedule_plugin_id").value;
            const instanceName = document.getElementById("schedule_instance_name").value;
            const refreshType = document.querySelector('input[name="scheduleRefreshType"]:checked').value;
            
            let requestData = {
                plugin_id: pluginId,
                instance_name: instanceName,
                refreshType: refreshType
            };
            
            if (refreshType === "interval") {
                requestData.interval = document.getElementById("schedule-interval").value;
                requestData.unit = document.getElementById("schedule-unit").value;
            } else if (refreshType === "scheduled") {
                requestData.refreshTime = document.getElementById("schedule-scheduled").value;
            } else if (refreshType === "cron") {
                requestData.cronExpression = document.getElementById("schedule-cronExpression").value;
            }
            
            try {
                const response = await fetch("{{ url_for('plugin.update_plugin_schedule') }}", {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();
                if (response.ok) {
                    closeScheduleModal();
                    sessionStorage.setItem("storedMessage", JSON.stringify({ type: "success", text: `Success! ${result.message}` }));
                    location.reload();
                } else {
                    showResponseModal('failure', `Error! ${result.error}`);
                }
            } catch (error) {
                console.error('Error:', error);
                showResponseModal('failure', 'An error occurred while updating the schedule.');
            }
        }

        // Setup radio/input interactions for schedule modal
        document.addEventListener('DOMContentLoaded', () => {
            const groupInterval = document.getElementById('schedule-group-interval');
            const radioInterval = document.getElementById('schedule-refresh-interval');
            const inputInterval = document.getElementById('schedule-interval');

            const groupScheduled = document.getElementById('schedule-group-scheduled');
            const radioScheduled = document.getElementById('schedule-refresh-scheduled');
            const inputScheduled = document.getElementById('schedule-scheduled');

            const groupCron = document.getElementById('schedule-group-cron');
            const radioCron = document.getElementById('schedule-refresh-cron');
            const inputCron = document.getElementById('schedule-cronExpression');

            const activateGroup = (radio, input) => {
                radio.checked = true;
                setTimeout(() => input.focus(), 0);
            };

            groupInterval.addEventListener('click', (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
                activateGroup(radioInterval, inputInterval);
            });

            groupScheduled.addEventListener('click', (e) => {
                if (e.target.tagName === 'INPUT') return;
                activateGroup(radioScheduled, inputScheduled);
            });

            groupCron.addEventListener('click', (e) => {
                if (e.target.tagName === 'INPUT') return;
                activateGroup(radioCron, inputCron);
            });

            radioInterval.addEventListener('click', () => activateGroup(radioInterval, inputInterval));
            radioScheduled.addEventListener('click', () => activateGroup(radioScheduled, inputScheduled));
            radioCron.addEventListener('click', () => activateGroup(radioCron, inputCron));

            inputInterval.addEventListener('focus', () => (radioInterval.checked = true));
            inputScheduled.addEventListener('focus', () => (radioScheduled.checked = true));
            inputCron.addEventListener('focus', () => (radioCron.checked = true));
        });
    </script>
</head>
<body>
    <div class="frame">
        <!-- Back Button -->
        <button onclick="history.back()" class="back-button">← Back</button>
        <!-- Settings Header -->
        <div class="app-header">
            <div class="header-content">
                <div class="title-container">
                    <img src="{{ url_for('static', filename='icons/playlist.png') }}" alt="playlist icon" class="app-icon">
                    <h1 class="app-title">Playlists</h1>
                </div>
                <button class="header-button" onclick="openCreateModal()">New Playlist</button>
            </div>
        </div>
        <div class="separator"></div>

        <!-- Playlists Container -->
        <div class="playlist-list">
            {% for playlist in playlist_config.playlists %}
            <div class="playlist-item {% if playlist.name == playlist_config.active_playlist %}active{% endif %}">
                    <div class="playlist-header">
                        <span class="playlist-title">{{ playlist.name }}</span>
                        <button class="edit-button" onclick="openEditModal('{{ playlist.name }}', '{{ playlist.start_time }}','{{ playlist.end_time }}')"><img src="{{ url_for('static', filename='icons/settings.png') }}" alt="edit playlist" class="action-icon"></button>
                    </div>
                    <!-- Plugin List -->
                    <div class="plugin-list">
                        {% for plugin_instance in playlist.plugins %}
                        <div class="plugin-item">
                            <div class="plugin-info" id="{{plugin_instance.name}}">
                                <img src="{{ url_for('plugin.image', plugin_id=plugin_instance.plugin_id, filename='icon.png') }}" alt="Plugin Icon" class="plugin-icon">
                                <span class="plugin-instance">{{ plugin_instance.name }}</span>

                                <!-- Thumbnail preview - only show if image has been generated -->
                                {% if plugin_instance.latest_refresh_time %}
                                <div class="plugin-thumbnail-container" onclick="showThumbnailPreview('{{ playlist.name }}', '{{ plugin_instance.plugin_id }}', '{{ plugin_instance.name }}')">
                                    <img
                                        src="{{ url_for('plugin.plugin_instance_image', playlist_name=playlist.name, plugin_id=plugin_instance.plugin_id, instance_name=plugin_instance.name) }}"
                                        alt="Preview"
                                        class="plugin-thumbnail"
                                        title="Click to view full size"
                                        onerror="this.parentElement.style.display='none';"
                                    >
                                </div>
                                {% endif %}

                                <!-- Check if the current plugin is the one being displayed -->
                                {% if playlist.name == refresh_info.playlist and plugin_instance.name == refresh_info.plugin_instance %}
                                <span class="displayed-now">Displayed Now</span>
                                {% endif %}
                                <div id="loadingIndicator" class="loading-indicator small left-align"></div>

                            </div>
                            <div class="plugin-actions">
                                {% if plugin_instance.latest_refresh_time %}
                                    {% set refresh_time = plugin_instance.latest_refresh_time | format_relative_time %}
                                    <span class="latest-refresh" title="{{plugin_instance.latest_refresh_time}}">
                                        Refreshed {{ refresh_time }}
                                    </span>
                                {% endif %}

                                <a href="{{ url_for('plugin.plugin_page', plugin_id=plugin_instance.plugin_id) }}?instance={{ plugin_instance.name }}" class="edit-button" title="Edit Settings">
                                    <img src="{{ url_for('static', filename='icons/edit.png') }}" alt="edit plugin" class="action-icon">
                                </a>
                                <button class="edit-button" title="Edit Schedule" 
                                        data-plugin-id="{{ plugin_instance.plugin_id }}" 
                                        data-instance-name="{{ plugin_instance.name }}" 
                                        data-refresh='{{ plugin_instance.refresh | tojson }}'
                                        onclick="openEditScheduleModal(this)">
                                    <img src="{{ url_for('static', filename='icons/playlist.png') }}" alt="edit schedule" class="action-icon">
                                </button>
                                <button class="edit-button" title="Display Now" onclick="displayPluginInstance('{{ playlist.name }}', '{{ plugin_instance.plugin_id }}','{{ plugin_instance.name }}')">
                                    <img src="{{ url_for('static', filename='icons/display.png') }}" alt="display now" class="action-icon">
                                </button>
                                <button class="delete-button" title="Delete Plugin Instance" onclick="deletePluginInstance('{{ playlist.name }}', '{{ plugin_instance.plugin_id }}','{{ plugin_instance.name }}')">
                                    <img src="{{ url_for('static', filename='icons/remove.png') }}" alt="delete plugin" class="action-icon">
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Schedule Configuration Modal -->
    <div id="playlistModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">×</span>
            <h2 id="modalTitle">New Playlist</h2>
            <div class="separator"></div>
            <form id="scheduleForm" class="settings-form">
                <input type="hidden" id="editingPlaylistName" value="">  <!-- Track existing playlist -->

                <div class="form-group">
                    <label for="playlist_name" class="form-label">Playlist Name:</label>
                    <input type="text" id="playlist_name" name="playlist_name" placeholder="Type something..." required class="form-input">
                </div>
                <div class="form-group">
                    <label for="start_time" class="form-label">Display from </label>
                    <select id="start_time" name="start_time" class="form-input"></select>
                    <span> - </span>
                    <select id="end_time" name="end_time" class="form-input"></select>
                </div>
            </form>
            <div class="buttons-container">
                <button type="button" class="action-button" id="saveButton">Save</button>
                <button type="button" class="action-button warn hidden" id="deleteButton" onclick="deletePlaylist()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Edit Schedule Modal -->
    <div id="scheduleModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeScheduleModal()">×</span>
            <h2>Edit Refresh Schedule</h2>
            <div class="separator"></div>
            <form id="scheduleEditForm" class="settings-form">
                <input type="hidden" id="schedule_plugin_id" value="">
                <input type="hidden" id="schedule_instance_name" value="">
                
                <div class="form-group nowrap" id="schedule-group-interval">
                    <input type="radio" name="scheduleRefreshType" id="schedule-refresh-interval" value="interval" checked>
                    <label for="schedule-refresh-interval">Every</label>
                    <input type="number" id="schedule-interval" name="interval" class="form-input" required min="1" placeholder="Enter a number">
                    <select id="schedule-unit" name="unit" class="form-input" required>
                        <option value="minute">Minute</option>
                        <option value="hour">Hour</option>
                        <option value="day">Day</option>
                    </select>
                </div>

                <div class="form-group nowrap" id="schedule-group-scheduled">
                    <input type="radio" name="scheduleRefreshType" id="schedule-refresh-scheduled" value="scheduled">
                    <label for="schedule-refresh-scheduled">Daily at</label>
                    <input id="schedule-scheduled" class="time-input" type="time" name="refreshTime" step="900">
                </div>

                <div class="form-group nowrap" id="schedule-group-cron">
                    <input type="radio" name="scheduleRefreshType" id="schedule-refresh-cron" value="cron">
                    <label for="schedule-refresh-cron">Cron</label>
                    <input id="schedule-cronExpression" class="form-input" type="text" name="cronExpression" 
                           placeholder="*/15 * * * *" title="Cron expression (e.g., */15 * * * * for every 15 min)">
                </div>
            </form>
            <div class="buttons-container">
                <button type="button" class="action-button" onclick="updatePluginSchedule()">Save Schedule</button>
            </div>
        </div>
    </div>

    <!-- Success/Error Modal -->
    {% include 'response_modal.html' %}

    <!-- Thumbnail Preview Modal -->
    <div id="thumbnailPreviewModal" class="thumbnail-preview-modal">
        <div class="thumbnail-preview-content">
            <span class="thumbnail-preview-close" onclick="closeThumbnailPreview()">×</span>
            <img id="thumbnailPreviewImage" src="" alt="Plugin Instance Preview">
            <div class="thumbnail-preview-info" id="thumbnailPreviewInfo"></div>
        </div>
    </div>
</body>
</html>
